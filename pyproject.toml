[project]
name = "dev-gettsim"
version = "0.1.0"
description = "Pixi workspace for ttsim, gettsim, gettsim-personas, and soep-preparation."
requires-python = ">=3.13"

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.pixi.workspace]
channels = ["conda-forge"]
platforms = ["linux-64", "osx-64", "osx-arm64", "win-64"]

[tool.pixi.dependencies]
deepdiff = "*"
ipykernel = "*"
pygraphviz = "*"
python = "~=3.13.0"
pytest-xdist = "*"

[tool.pixi.pypi-dependencies]
jaxtyping = "*"
ttsim-backend = { path = "ttsim", editable = true }
mettsim = {path = "ttsim/src_mettsim", editable = true}
gettsim = { path = "gettsim", editable = true }
gettsim-personas = { path = "gettsim-personas", editable = true }
soep-preparation = { path = "soep-preparation", editable = true }
pdbp = ">=1.7.1"

# Features
# --------------------------------------------------------------------------------------

[tool.pixi.feature.jax]
platforms = ["linux-64", "osx-arm64", "win-64"]

[tool.pixi.feature.jax.pypi-dependencies]
jax = ">=0.8"
# jax-datetime = { git = "https://github.com/google/jax-datetime.git" }

[tool.pixi.feature.cuda]
platforms = ["linux-64"]
system-requirements = {cuda = "12"}

[tool.pixi.feature.cuda.target.linux-64.pypi-dependencies]
jax = {version = ">=0.8", extras = ["cuda12"]}

[tool.pixi.feature.metal]
platforms = ["osx-arm64"]

[tool.pixi.feature.metal.target.osx-arm64.pypi-dependencies]
jax = ">=0.8"
jax-metal = ">=0.1.1"

[tool.pixi.feature.ty.pypi-dependencies]
ty = "*"
types-PyYAML = "*"
types-pytz = "*"

# Tasks
# --------------------------------------------------------------------------------------

[tool.pixi.feature.test.tasks]
tests = "pytest"

[tool.pixi.feature.jax.tasks]
tests-jax = "pytest --backend=jax"

[tool.pixi.feature.cuda.tasks]
tests-jax = "pytest --backend=jax"

[tool.pixi.feature.ty.tasks]
ty = "ty check"

# Environments
# --------------------------------------------------------------------------------------

[tool.pixi.environments]
py313-jax = ["test", "jax"]
py313-cuda = ["test", "cuda"]
py313-metal = ["test", "metal"]
ty = ["ty"]


[tool.ruff.lint.per-file-ignores]
"conftest.py" = ["ANN", "INP001"]

# ======================================================================================
# ty configuration
# ======================================================================================

[tool.ty.environment]
root = ["."]

[tool.ty.src]
respect-ignore-files = false
exclude = ["**/.pixi/"]

[tool.ty.rules]
invalid-return-type = "error"
ambiguous-protocol-member = "error"
deprecated = "error"
division-by-zero = "error"
ignore-comment-unknown-rule = "error"
invalid-argument-type = "error"
invalid-ignore-comment = "error"
possibly-missing-attribute = "error"
possibly-missing-implicit-call = "error"
possibly-missing-import = "error"
possibly-unresolved-reference = "error"
redundant-cast = "error"
undefined-reveal = "error"
unresolved-global = "error"
unsupported-base = "error"
unused-ignore-comment = "error"
useless-overload-body = "error"

[[tool.ty.overrides]]
include = ["ttsim/**"]

[tool.ty.overrides.rules]
invalid-return-type = "ignore"

[[tool.ty.overrides]]
include = ["gettsim/**"]

[tool.ty.overrides.rules]
invalid-return-type = "ignore"

[[tool.ty.overrides]]
include = ["gettsim/docs/**"]

[tool.ty.overrides.rules]
unresolved-attribute = "ignore"


[tool.pytask.ini_options]
paths = ["soep-preparation/src/soep_preparation"]
pdbcls = "pdbp:Pdb"
editor_url_scheme = "vscode"
task_files = ["task_*.py", "task.py", "tasks.py"]

[tool.pytest.ini_options]
addopts = ["--pdbcls=pdbp:Pdb"]
filterwarnings = [
    "ignore:.*XMLParser*:DeprecationWarning",
    "ignore:.*'tree.iter()'*:PendingDeprecationWarning",
    "ignore:.*Sorting*:FutureWarning",
    "ignore:The TerminalReporter.writer attribute is",
    "ignore:Repeated execution of the test suite",
    "ignore:Using or importing the ABCs from 'collections'",
    "ignore:Explicitly requested dtype .*64 requested in zeros_like"
]
markers = [
    "wip: Tests that are work-in-progress.",
    "unit: Flag for unit tests which target mainly a single function.",
    "integration: Flag for integration tests which may comprise of multiple unit tests.",
    "end_to_end: Flag for tests that cover the whole program.",
    "skipif_jax: skip test if backend is jax",
    "skipif_numpy: skip test if backend is numpy"
]
